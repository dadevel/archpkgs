pkgname=trevorspray
pkgver=latest
pkgrel=1
url="https://github.com/blacklanternsecurity/${pkgname}.git"
arch=(any)
license=(GPL3)
depends=(python)
source=("git+${url}")
sha256sums=(SKIP)

package() {
  cd "${srcdir}/${pkgname}"
  mkdir -p "${pkgdir}"/opt/archpkgs/{bin,lib} "${pkgdir}/opt/archpkgs/${pkgname}"
  python -m venv "${pkgdir}/opt/archpkgs/${pkgname}"
  source "${pkgdir}/opt/archpkgs/${pkgname}/bin/activate"
  sed -i 's|^trevorproxy = .*$|trevorproxy = "git+https://github.com/blacklanternsecurity/trevorproxy"|' ./pyproject.toml
  pip install .
  pip freeze
  for binname in "${pkgname}" trevorproxy; do
    cat << EOF > "${pkgdir}/opt/archpkgs/bin/${binname}"
#!/bin/sh
set -eu
export VIRTUAL_ENV=/opt/archpkgs/${pkgname}
export PATH=\$VIRTUAL_ENV/bin:\$PATH
exec python /opt/archpkgs/${pkgname}/bin/${binname} "\$@"
EOF
    chmod +x "${pkgdir}/opt/archpkgs/bin/${binname}"
  done
}

pkgver() {
  cd "${srcdir}/${pkgname}"
  echo "$(git rev-list --count HEAD).$(git rev-parse --short HEAD)"
}
